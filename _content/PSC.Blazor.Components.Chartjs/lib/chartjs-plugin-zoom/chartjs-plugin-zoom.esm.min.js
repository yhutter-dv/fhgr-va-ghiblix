import Hammer from"hammerjs";import{each,valueOrDefault,callback,sign}from"chart.js/helpers";const getModifierKey=e=>e&&e.enabled&&e.modifierKey,keyPressed=(e,t)=>e&&t[e+"Key"],keyNotPressed=(e,t)=>e&&!t[e+"Key"];function directionEnabled(e,t,n){return void 0===e||("string"==typeof e?-1!==e.indexOf(t):"function"==typeof e&&-1!==e({chart:n}).indexOf(t))}function debounce(e,t){let n;return function(){return clearTimeout(n),n=setTimeout(e,t),t}}function getScaleUnderPoint({x:t,y:n},e){var a=e.scales,o=Object.keys(a);for(let e=0;e<o.length;e++){var i=a[o[e]];if(n>=i.top&&n<=i.bottom&&t>=i.left&&t<=i.right)return i}return null}function getEnabledScalesByPoint(t,e,n){e=getScaleUnderPoint(e,n);if(e&&directionEnabled(t,e.axis,n))return[e];const a=[];return each(n.scales,function(e){directionEnabled(t,e.axis,n)||a.push(e)}),a}const chartStates=new WeakMap;function getState(e){let t=chartStates.get(e);return t||(t={originalScaleLimits:{},updatedScaleLimits:{},handlers:{},panDelta:{}},chartStates.set(e,t)),t}function removeState(e){chartStates.delete(e)}function zoomDelta(e,t,n){var a=e.max-e.min,t=a*(t-1),n=e.isHorizontal()?n.x:n.y,a=Math.max(0,Math.min(1,(e.getValueForPixel(n)-e.min)/a||0));return{min:t*a,max:t*(1-a)}}function getLimit(e,t,n,a,o){let i=n[a];return"original"===i&&(a=e.originalScaleLimits[t.id][a],i=valueOrDefault(a.options,a.scale)),valueOrDefault(i,o)}function updateRange(e,{min:t,max:n},a,o=!1){const i=getState(e.chart),{id:r,axis:l,options:c}=e;var m=a&&(a[r]||a[l])||{},{minRange:s=0}=m,d=getLimit(i,e,m,"min",-1/0),u=getLimit(i,e,m,"max",1/0),a=Math.max(t,d),m=Math.min(n,u),s=o?Math.max(m-a,s):e.max-e.min;return m-a!==s?m-s<d?n=(t=a)+s:u<a+s?t=(n=m)-s:(t=a-(s=(s-m+a)/2),n=m+s):(t=a,n=m),c.min=t,c.max=n,i.updatedScaleLimits[e.id]={min:t,max:n},e.parse(t)!==e.min||e.parse(n)!==e.max}function zoomNumericalScale(e,t,n,a){n=zoomDelta(e,t,n);return updateRange(e,{min:e.min+n.min,max:e.max-n.max},a,!0)}const integerChange=e=>0===e||isNaN(e)?0:e<0?Math.min(Math.round(e),-1):Math.max(Math.round(e),1);function existCategoryFromMaxZoom(e){var t=e.getLabels().length-1;0<e.min&&--e.min,e.max<t&&(e.max+=1)}function zoomCategoryScale(e,t,n,a){n=zoomDelta(e,t,n);return e.min===e.max&&t<1&&existCategoryFromMaxZoom(e),updateRange(e,{min:e.min+integerChange(n.min),max:e.max-integerChange(n.max)},a,!0)}function scaleLength(e){return e.isHorizontal()?e.width:e.height}function panCategoryScale(e,t,n){var a=e.getLabels().length-1;let{min:o,max:i}=e;var r=Math.max(i-o,1),l=Math.round(scaleLength(e)/Math.max(r,10)),c=Math.round(Math.abs(t/l));let m;return t<-l?(i=Math.min(i+c,a),o=1===r?i:i-r,m=i===a):l<t&&(o=Math.max(0,o-c),i=1===r?o:o+r,m=0===o),updateRange(e,{min:o,max:i},n)||m}const OFFSETS={second:500,minute:3e4,hour:18e5,day:432e5,week:3024e5,month:1296e6,quarter:5184e6,year:157248e5};function panNumericalScale(e,t,n,a=!1){var{min:o,max:i,options:r}=e,r=r.time&&r.time.round,r=OFFSETS[r]||0,o=e.getValueForPixel(e.getPixelForValue(o+r)-t),i=e.getValueForPixel(e.getPixelForValue(i+r)-t),{min:r=-1/0,max:t=1/0}=a&&n&&n[e.axis]||{};return!!(isNaN(o)||isNaN(i)||o<r||t<i)||updateRange(e,{min:o,max:i},n,a)}function panNonLinearScale(e,t,n){return panNumericalScale(e,t,n,!0)}const zoomFunctions={category:zoomCategoryScale,default:zoomNumericalScale},panFunctions={category:panCategoryScale,default:panNumericalScale,logarithmic:panNonLinearScale,timeseries:panNonLinearScale};function shouldUpdateScaleLimits(e,t,n){var{id:a,options:{min:o,max:e}}=e;if(!t[a]||!n[a])return!0;a=n[a];return a.min!==o||a.max!==e}function removeMissingScales(n,a){each(n,(e,t)=>{a[t]||delete n[t]})}function storeOriginalScaleLimits(e,t){var e=e["scales"];const{originalScaleLimits:n,updatedScaleLimits:a}=t;return each(e,function(e){shouldUpdateScaleLimits(e,n,a)&&(n[e.id]={min:{scale:e.min,options:e.options.min},max:{scale:e.max,options:e.options.max}})}),removeMissingScales(n,e),removeMissingScales(a,e),n}function doZoom(e,t,n,a){var o=zoomFunctions[e.type]||zoomFunctions.default;callback(o,[e,t,n,a])}function getCenter(e){e=e.chartArea;return{x:(e.left+e.right)/2,y:(e.top+e.bottom)/2}}function zoom(e,t,n="none"){const{x:a=1,y:o=1,focalPoint:i=getCenter(e)}="number"==typeof t?{x:t,y:t}:t;var r=getState(e);const{options:{limits:l,zoom:c}}=r;var{mode:m="xy",overScaleMode:t}=c||{};storeOriginalScaleLimits(e,r);const s=1!==a&&directionEnabled(m,"x",e),d=1!==o&&directionEnabled(m,"y",e);t=t&&getEnabledScalesByPoint(t,i,e);each(t||e.scales,function(e){e.isHorizontal()&&s?doZoom(e,a,i,l):!e.isHorizontal()&&d&&doZoom(e,o,i,l)}),e.update(n),callback(c.onZoom,[{chart:e}])}function getRange(e,t,n){t=e.getValueForPixel(t),n=e.getValueForPixel(n);return{min:Math.min(t,n),max:Math.max(t,n)}}function zoomRect(e,t,n,a="none"){var o=getState(e);const{options:{limits:i,zoom:r}}=o;var{mode:l="xy"}=r;storeOriginalScaleLimits(e,o);const c=directionEnabled(l,"x",e),m=directionEnabled(l,"y",e);each(e.scales,function(e){e.isHorizontal()&&c?updateRange(e,getRange(e,t.x,n.x),i,!0):!e.isHorizontal()&&m&&updateRange(e,getRange(e,t.y,n.y),i,!0)}),e.update(a),callback(r.onZoom,[{chart:e}])}function zoomScale(e,t,n,a="none"){storeOriginalScaleLimits(e,getState(e)),updateRange(e.scales[t],n,void 0,!0),e.update(a)}function resetZoom(e,t="default"){var n=getState(e);const a=storeOriginalScaleLimits(e,n);each(e.scales,function(e){const t=e.options;a[e.id]?(t.min=a[e.id].min.options,t.max=a[e.id].max.options):(delete t.min,delete t.max)}),e.update(t),callback(n.options.zoom.onZoomComplete,[{chart:e}])}function getOriginalRange(e,t){e=e.originalScaleLimits[t];if(e){var{min:t,max:e}=e;return valueOrDefault(e.options,e.scale)-valueOrDefault(t.options,t.scale)}}function getZoomLevel(e){const n=getState(e);let a=1,o=1;return each(e.scales,function(e){var t=getOriginalRange(n,e.id);t&&(e=Math.round(t/(e.max-e.min)*100)/100,a=Math.min(a,e),o=Math.max(o,e))}),a<1?a:o}function panScale(e,t,n,a){const o=a["panDelta"];a=o[e.id]||0;sign(a)===sign(t)&&(t+=a);a=panFunctions[e.type]||panFunctions.default;callback(a,[e,t,n])?o[e.id]=0:o[e.id]=t}function pan(e,t,n,a="none"){const{x:o=0,y:i=0}="number"==typeof t?{x:t,y:t}:t,r=getState(e),{options:{pan:l,limits:c}}=r;var{mode:m="xy",onPan:t}=l||{};storeOriginalScaleLimits(e,r);const s=0!==o&&directionEnabled(m,"x",e),d=0!==i&&directionEnabled(m,"y",e);each(n||e.scales,function(e){e.isHorizontal()&&s?panScale(e,o,c,r):!e.isHorizontal()&&d&&panScale(e,i,c,r)}),e.update(a),callback(t,[{chart:e}])}function getInitialScaleBounds(e){var t=getState(e);const n={};for(const i of Object.keys(e.scales)){var{min:a,max:o}=t.originalScaleLimits[i]||{min:{},max:{}};n[i]={min:a.scale,max:o.scale}}return n}function isZoomedOrPanned(e){var t=getInitialScaleBounds(e);for(const o of Object.keys(e.scales)){var{min:n,max:a}=t[o];if(void 0!==n&&e.scales[o].min!==n)return!0;if(void 0!==a&&e.scales[o].max!==a)return!0}return!1}function removeHandler(e,t){const n=getState(e)["handlers"],a=n[t];a&&a.target&&(a.target.removeEventListener(t,a),delete n[t])}function addHandler(t,e,n,a){const{handlers:o,options:i}=getState(t);var r=o[n];r&&r.target===e||(removeHandler(t,n),o[n]=e=>a(t,e,i),(o[n].target=e).addEventListener(n,o[n]))}function mouseMove(e,t){const n=getState(e);n.dragStart&&(n.dragging=!0,n.dragEnd=t,e.update("none"))}function zoomStart(e,t,n){var{onZoomStart:a,onZoomRejected:o}=n;if(a){var{left:i,top:n}=t.target.getBoundingClientRect(),n={x:t.clientX-i,y:t.clientY-n};if(!1===callback(a,[{chart:e,event:t,point:n}]))return callback(o,[{chart:e,event:t}]),!1}}function mouseDown(e,t){const n=getState(e);var{pan:a,zoom:o={}}=n.options;if(keyPressed(getModifierKey(a),t)||keyNotPressed(getModifierKey(o.drag),t))return callback(o.onZoomRejected,[{chart:e,event:t}]);!1!==zoomStart(e,t,o)&&(n.dragStart=t,addHandler(e,e.canvas,"mousemove",mouseMove))}function computeDragRect(e,t,n,a){var{left:o,top:i}=n.target.getBoundingClientRect(),r=directionEnabled(t,"x",e),t=directionEnabled(t,"y",e);let{top:l,left:c,right:m,bottom:s,width:d,height:u}=e.chartArea;r&&(c=Math.min(n.clientX,a.clientX)-o,m=Math.max(n.clientX,a.clientX)-o),t&&(l=Math.min(n.clientY,a.clientY)-i,s=Math.max(n.clientY,a.clientY)-i);a=m-c,i=s-l;return{left:c,top:l,right:m,bottom:s,width:a,height:i,zoomX:r&&a?1+(d-a)/d:1,zoomY:t&&i?1+(u-i)/u:1}}function mouseUp(e,t){const n=getState(e);if(n.dragStart){removeHandler(e,"mousemove");var{mode:a,onZoomComplete:o,drag:{threshold:i=0}}=n.options.zoom,r=computeDragRect(e,a,n.dragStart,t),t=directionEnabled(a,"x",e)?r.width:0,a=directionEnabled(a,"y",e)?r.height:0,a=Math.sqrt(t*t+a*a);if(n.dragStart=n.dragEnd=null,a<=i)return n.dragging=!1,void e.update("none");zoomRect(e,{x:r.left,y:r.top},{x:r.right,y:r.bottom},"zoom"),setTimeout(()=>n.dragging=!1,500),callback(o,[{chart:e}])}}function wheelPreconditions(e,t,n){if(keyNotPressed(getModifierKey(n.wheel),t))callback(n.onZoomRejected,[{chart:e,event:t}]);else if(!1!==zoomStart(e,t,n)&&(t.cancelable&&t.preventDefault(),void 0!==t.deltaY))return!0}function wheel(e,t){const{handlers:{onZoomComplete:n},options:{zoom:a}}=getState(e);var o;wheelPreconditions(e,t,a)&&(o=t.target.getBoundingClientRect(),zoom(e,{x:e=1+(0<=t.deltaY?-a.wheel.speed:a.wheel.speed),y:e,focalPoint:{x:t.clientX-o.left,y:t.clientY-o.top}}),n&&n())}function addDebouncedHandler(e,t,n,a){n&&(getState(e).handlers[t]=debounce(()=>callback(n,[{chart:e}]),a))}function addListeners(e,t){var n=e.canvas,{wheel:a,drag:o,onZoomComplete:t}=t.zoom;a.enabled?(addHandler(e,n,"wheel",wheel),addDebouncedHandler(e,"onZoomComplete",t,250)):removeHandler(e,"wheel"),o.enabled?(addHandler(e,n,"mousedown",mouseDown),addHandler(e,n.ownerDocument,"mouseup",mouseUp)):(removeHandler(e,"mousedown"),removeHandler(e,"mousemove"),removeHandler(e,"mouseup"))}function removeListeners(e){removeHandler(e,"mousedown"),removeHandler(e,"mousemove"),removeHandler(e,"mouseup"),removeHandler(e,"wheel"),removeHandler(e,"click")}function createEnabler(i,r){return function(e,t){var{pan:n,zoom:a={}}=r.options;if(!n||!n.enabled)return!1;var o=t&&t.srcEvent;return!o||(!(!r.panning&&"mouse"===t.pointerType&&(keyNotPressed(getModifierKey(n),o)||keyPressed(getModifierKey(a.drag),o)))||(callback(n.onPanRejected,[{chart:i,event:t}]),!1))}}function pinchAxes(e,t){var n=Math.abs(e.clientX-t.clientX),e=Math.abs(e.clientY-t.clientY),t=n/e;let a,o;return.3<t&&t<1.7?a=o=!0:e<n?a=!0:o=!0,{x:a,y:o}}function handlePinch(e,t,n){var a,o,i,r,l;t.scale&&({center:a,pointers:l}=n,o=1/t.scale*n.scale,i=n.target.getBoundingClientRect(),r=pinchAxes(l[0],l[1]),l=t.options.zoom.mode,zoom(e,{x:r.x&&directionEnabled(l,"x",e)?o:1,y:r.y&&directionEnabled(l,"y",e)?o:1,focalPoint:{x:a.x-i.left,y:a.y-i.top}}),t.scale=n.scale)}function startPinch(e,t){t.options.zoom.pinch.enabled&&(t.scale=1)}function endPinch(e,t,n){t.scale&&(handlePinch(e,t,n),t.scale=null,callback(t.options.zoom.onZoomComplete,[{chart:e}]))}function handlePan(e,t,n){var a=t.delta;a&&(t.panning=!0,pan(e,{x:n.deltaX-a.x,y:n.deltaY-a.y},t.panScales),t.delta={x:n.deltaX,y:n.deltaY})}function startPan(e,t,n){var{enabled:a,overScaleMode:o,onPanStart:i,onPanRejected:r}=t.options.pan;if(a){a=n.target.getBoundingClientRect(),a={x:n.center.x-a.left,y:n.center.y-a.top};if(!1===callback(i,[{chart:e,event:n,point:a}]))return callback(r,[{chart:e,event:n}]);t.panScales=o&&getEnabledScalesByPoint(o,a,e),t.delta={x:0,y:0},clearTimeout(t.panEndTimeout),handlePan(e,t,n)}}function endPan(e,t){t.delta=null,t.panning&&(t.panEndTimeout=setTimeout(()=>t.panning=!1,500),callback(t.options.pan.onPanComplete,[{chart:e}]))}const hammers=new WeakMap;function startHammer(t,e){const n=getState(t);var a=t.canvas,{pan:o,zoom:e}=e;const i=new Hammer.Manager(a);e&&e.pinch.enabled&&(i.add(new Hammer.Pinch),i.on("pinchstart",()=>startPinch(t,n)),i.on("pinch",e=>handlePinch(t,n,e)),i.on("pinchend",e=>endPinch(t,n,e))),o&&o.enabled&&(i.add(new Hammer.Pan({threshold:o.threshold,enable:createEnabler(t,n)})),i.on("panstart",e=>startPan(t,n,e)),i.on("panmove",e=>handlePan(t,n,e)),i.on("panend",()=>endPan(t,n))),hammers.set(t,i)}function stopHammer(e){const t=hammers.get(e);t&&(t.remove("pinchstart"),t.remove("pinch"),t.remove("pinchend"),t.remove("panstart"),t.remove("pan"),t.remove("panend"),t.destroy(),hammers.delete(e))}var version="1.2.1",plugin={id:"zoom",version:version,defaults:{pan:{enabled:!1,mode:"xy",threshold:10,modifierKey:null},zoom:{wheel:{enabled:!1,speed:.1,modifierKey:null},drag:{enabled:!1,modifierKey:null},pinch:{enabled:!1},mode:"xy"}},start:function(a,e,t){const n=getState(a);n.options=t,Object.prototype.hasOwnProperty.call(t.zoom,"enabled")&&console.warn("The option `zoom.enabled` is no longer supported. Please use `zoom.wheel.enabled`, `zoom.drag.enabled`, or `zoom.pinch.enabled`."),Hammer&&startHammer(a,t),a.pan=(e,t,n)=>pan(a,e,t,n),a.zoom=(e,t)=>zoom(a,e,t),a.zoomScale=(e,t,n)=>zoomScale(a,e,t,n),a.resetZoom=e=>resetZoom(a,e),a.getZoomLevel=()=>getZoomLevel(a),a.getInitialScaleBounds=()=>getInitialScaleBounds(a),a.isZoomedOrPanned=()=>isZoomedOrPanned(a)},beforeEvent(e){e=getState(e);if(e.panning||e.dragging)return!1},beforeUpdate:function(e,t,n){const a=getState(e);addListeners(e,a.options=n)},beforeDatasetsDraw:function(e,t,n){var{dragStart:a,dragEnd:o}=getState(e);if(o){var{left:i,top:r,width:a,height:o}=computeDragRect(e,n.zoom.mode,a,o),n=n.zoom.drag;const l=e.ctx;l.save(),l.beginPath(),l.fillStyle=n.backgroundColor||"rgba(225,225,225,0.3)",l.fillRect(i,r,a,o),0<n.borderWidth&&(l.lineWidth=n.borderWidth,l.strokeStyle=n.borderColor||"rgba(225,225,225)",l.strokeRect(i,r,a,o)),l.restore()}},stop:function(e){removeListeners(e),Hammer&&stopHammer(e),removeState(e)},panFunctions:panFunctions,zoomFunctions:zoomFunctions};export{plugin as default,pan,resetZoom,zoom,zoomScale};